<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Websocketd chat</title>
    <style>
html, body { height: 100%; margin: 0;}
#messages {
height: 90%;
overflow: auto;
}
#userlist {
    width: 10em;
    position: absolute;
    bottom: 1px;
    right: 1px;
    background-color: Pink;
    padding: 1em;
}
    </style>
  </head>
  <body>

<!-- 
Working with websocked chat_server, ws_url needs to be properly set, so client can go to
living instance of chat server.
Variable number of old messages can be set, to view more history.
User name and room name is set by http parameters user and room
-->
    <div id="userlist"></div>
    <div id="messages"></div>
    <form onsubmit="send();return false;">
        Message <input type="text" id="messageinput" autofocus="autofocus" list="usernames" autocomplete="off">
        <input type="submit" value="Send" id="sendButton">
    </form>
    <div>
        <button type="button" onclick="ws.close();" id="closeSocketButton">Close connection</button>
    </div>
    <datalist id="usernames">
        <select name="usernames">
        </select>
    </datalist>

    <script type="text/javascript">
    var ws_url = 'ws://localhost:8089/' + get_http_param('room');
    var ws = new WebSocket(ws_url);
    var number_of_old_messages = 15;
    var last_message_id = 1;
    var userListKeyword = "Userlist: ";
    var welcomeMessage = "Welcome to the chat room";
    var username = ""; // will be updated after welcomemessage

    ws.onopen = function() {
        document.body.style.backgroundColor = '#cfc';
        document.getElementById('closeSocketButton').disabled=false;
        document.getElementById('sendButton').disabled=false;
    }
    ws.onclose = function() {
        document.getElementById('closeSocketButton').disabled=true;
        document.getElementById('sendButton').disabled=true;
        display_received_message("Connection closed.");
        document.body.style.backgroundColor = null;
     };
    ws.onerror = function() {
         display_received_message("error: " + event.error);
    };
    ws.onmessage = function(event) {
        if (event.data.indexOf(userListKeyword) > -1) {
            updateUserList(event.data);
        }
        else {
            if (event.data.indexOf(welcomeMessage) > -1 & last_message_id == 1) {
                username=event.data.split(" ").pop().slice(0, -1);
                console.log("Username is " + username);
            }
            display_received_message(event.data);
        }
    };

    // functions for user list

    function updateUserList(userdata) {
        /***
           sets two lists, userlist for display purposes and usernames to make writing to users easy
        ***/
        console.log("updating user list " + userdata);
        result = '<select name="usernames">\n';
        result2 = '<h4>User List</h4>\n<ul>\n';
        userdata = userdata.slice(userdata.indexOf(userListKeyword) + userListKeyword.length)
        users = userdata.split(",");
        for (index = 0, len = users.length; index < len; ++index) {
            if (users[index] != "" & users[index] != username) {
                result = result + '<option value="' + (users[index]) + ': "></option>\n';
                result2 = result2 + '<li>' + users[index] + '\n';
            }
        }
        result = result + "</select>\n";
        result2 = result2 + "</ul>\n";
        document.getElementById("usernames").innerHTML = result;
        document.getElementById("userlist").innerHTML = result2;
    }

    function get_http_param(name) {
        if(name=(new RegExp('[?&]'+encodeURIComponent(name)+'=([^&]*)')).exec(location.search))
            return decodeURIComponent(name[1]);
    }

    function send() {
         ws.send(document.getElementById("messageinput").value);
         document.getElementById("messageinput").value = "";
    }

    function display_received_message(message_text) {
        document.getElementById('messages').innerHTML = "<p id=\"message" + last_message_id +"\">" + message_text + "</p>" + document.getElementById('messages').innerHTML;
        last_message_id++;
        if (last_message_id > number_of_old_messages) { // do not display old messages
            remove_number = last_message_id - number_of_old_messages;
            document.getElementById('messages').removeChild(document.getElementById("message" + remove_number))
        }
    }


    
    </script>

  </body>
</html>
