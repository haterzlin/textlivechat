<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Websocketd chat</title>
    <style>
html, body { height: 100%; margin: 0;}
#messages {
height: 90%;
overflow: auto;
}
    </style>
  </head>
  <body>

<!-- 
Working with websocked chat_server, ws_url needs to be properly set, so client can go to
living instance of chat server.
Variable number of old messages can be set, to view more history.
User name and room name is set by http parameters user and room
-->

    <div id="messages"></div>
    <form onsubmit="send();return false;">
        Message <input type="text" id="messageinput"/>
        <input type="submit" value="Send" id="sendButton">
    </form>
    <div>
        <button type="button" onclick="closeSocket();" id="closeSocketButton">Close connection</button>
    </div>

    <script type="text/javascript">
    var ws_url = 'ws://localhost:8089/';
    var ws = new WebSocket(ws_url);
    var number_of_old_messages = 15;
    var last_message_id = 1;
    // time params for creating connection
    var interval = 50; // miliseconds between checks
    var timeout = 5000; // stop trying yo connect after this timeout
    var timeStarted = Date.now();
    

    function initialize_websocket() {
        console.log("succesfully connected to websocket");
        // mapping events after succesful connection
        document.body.style.backgroundColor = '#cfc';
        ws.onerror = function() {
             display_received_message("error: " + event.error);
         };
        ws.onmessage = function(event) {
              switch (event.data) {
                  case "Please enter your name:":
                      ws.send(get_http_param('user'));
                      break;
                  case "Please enter room name:":
                      ws.send(get_http_param('room'));
                      break;
                  default:
                      display_received_message(event.data);
              }
        };
        // connection is initialized and message "enter your name" was send, server is waiting for  response
        ws.send(get_http_param('user')); 
    }

    function wait_for_websocket_connection() {
        if (ws.readyState === 1) {
            console.log("succesfully connected to websocket");
            initialize_websocket();
        }
        else {
            if (Date.now() > timeStarted + timeout) {
                closeSocketAfter();
                display_received_message("Connection time limit expired.");
            }
            else {
                setTimeout(wait_for_websocket_connection, interval);
                console.log("waiting for connection to websocket " + Date.now());
            }
        }
    }

    function get_http_param(name) {
        if(name=(new RegExp('[?&]'+encodeURIComponent(name)+'=([^&]*)')).exec(location.search))
            return decodeURIComponent(name[1]);
    }

    function send() {
         ws.send(document.getElementById("messageinput").value);
         document.getElementById("messageinput").value = "";
    }

    function display_received_message(message_text) {
        document.getElementById('messages').innerHTML = "<p id=\"message" + last_message_id +"\">" + message_text + "</p>" + document.getElementById('messages').innerHTML;
        last_message_id++;
        if (last_message_id > number_of_old_messages) { // do not display old messages
            remove_number = last_message_id - number_of_old_messages;
            document.getElementById('messages').removeChild(document.getElementById("message" + remove_number))
        }
    }

    function closeSocket() {
        if (ws.readyState == WebSocket.OPEN) {
            ws.close();
            closeSocketAfter();
        }
    }

    function closeSocketAfter() {
        document.getElementById('closeSocketButton').disabled=true;
        document.getElementById('sendButton').disabled=true;
        display_received_message("Connection closed.");
        document.body.style.backgroundColor = null;
    }

    wait_for_websocket_connection();
    
    </script>

  </body>
</html>
